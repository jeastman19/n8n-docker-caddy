services:
  init-qdrant:
    image: curlimages/curl:8.8.0       # dispone de curl completo
    container_name: init-qdrant
    depends_on:
      - qdrant
    networks: ["n8n-network"]
    environment:
      - QDRANT_API_KEY=${QDRANT__SERVICE__API_KEY}
      - QDRANT_HOST=http://qdrant:6333  # nombre del servicio interno
    entrypoint: >
      sh -c '
        echo "üîÑ Esperando a Qdrant‚Ä¶";
        until curl -sf "$QDRANT_HOST/healthz"; do sleep 1; done;
        echo "‚úÖ Qdrant est√° activo.";
        
        if curl -s -H "api-key: $QDRANT_API_KEY" \
               "$QDRANT_HOST/collections/faq" \
               | grep -q "\"status\":\"ok\""; then
          echo "‚ÑπÔ∏è  La colecci√≥n faq ya existe. Nada que hacer.";
          exit 0;
        fi;
        
        echo "üöÄ Creando colecci√≥n faq (1536 dimensiones, distancia Dot)‚Ä¶";
        curl -s -X PUT "$QDRANT_HOST/collections/faq" \
             -H "Content-Type: application/json" \
             -H "api-key: $QDRANT_API_KEY" \
             -d "{\"vectors\": {\"size\": 1536, \"distance\": \"Dot\"}}";
        echo "‚úÖ Colecci√≥n faq creada.";
      '
    restart: "no"    # solo se ejecuta una vez
